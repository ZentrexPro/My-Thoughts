<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta Thoughts</title>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Audiowide&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #262626;
      --accent: #fd1d1d;
      --gradient: linear-gradient(90deg, #fd1d1d, #fcb045, #833ab4);
      --story-ring: linear-gradient(45deg, #fcb045, #fd1d1d, #833ab4, #fcb045);
      --bg: #181818;
      --white: #fff;
      --gray: #aaa;
      --card-bg: rgba(20,20,20,0.93);
    }
    html,body {
      min-height:100%;
      margin:0;
      background: var(--bg);
      color: var(--white);
      font-family: 'Roboto', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      min-height: 100vh;
      margin: 0;
      padding-bottom: 72px;
      position: relative;
      overflow-x: hidden;
    }
    /* --- Top bar --- */
    .topbar {
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      padding: 18px 12px 10px 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .topbar h1 {
      font-family: 'Audiowide', cursive;
      font-size: 24px;
      margin: 0;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .topbar .add-story-btn {
      background: var(--gradient);
      border: none;
      color: #fff;
      border-radius: 16px;
      padding: 8px 16px;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      transition: box-shadow .2s;
      box-shadow: 0 2px 12px rgba(253,29,29,0.08);
    }
    /* --- Story bar --- */
    .story-bar {
      width: 100%;
      max-width: 600px;
      overflow-x: auto;
      display: flex;
      gap: 14px;
      padding: 10px 0 10px 8px;
      background: var(--bg);
      border-bottom: 1px solid #292929;
      position: sticky;
      top: 54px;
      z-index: 8;
    }
    .story-avatar {
      flex: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .story-ring {
      width: 62px; height: 62px;
      border-radius: 50%;
      padding: 3px;
      background: var(--story-ring);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px #0004;
      position: relative;
    }
    .story-ring.seen {
      filter: grayscale(1) brightness(1.1);
      opacity: 0.7;
    }
    .story-avatar img {
      width: 56px; height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: #232323;
    }
    .story-avatar .add {
      background: var(--gradient);
      color: #fff;
      font-size: 26px;
      width: 56px; height: 56px;
      border-radius: 50%;
      display: flex;align-items:center;justify-content:center;
      border: none;
      cursor: pointer;
    }
    .story-avatar .label {
      font-size: 12px;
      color: var(--gray);
      margin-top: 2px;
      text-align: center;
      max-width: 62px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* --- Story Overlay --- */
    .story-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .story-overlay.active {
      display: flex;
    }
    .story-media {
      width: 96vw; max-width: 420px;
      height: 72vw; max-height: 720px;
      background: #111;
      border-radius: 20px;
      box-shadow: 0 10px 40px #000c;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
      justify-content: center;
    }
    .story-media img, .story-media video {
      width: 100%; height: 100%; object-fit:contain; background: #111; border-radius: 20px;
    }
    .story-media .close-btn {
      position: absolute;
      top: 12px; right: 12px;
      background: rgba(0,0,0,0.6);
      border: none;
      color: #fff;
      font-size: 22px;
      border-radius: 50%;
      width: 36px; height: 36px;
      display: flex; align-items:center; justify-content:center;
      cursor: pointer;
      z-index: 10;
    }
    .story-media .play-count {
      position: absolute; top: 12px; left: 12px;
      background: rgba(0,0,0,0.55);
      color: #fff; padding: 4px 14px;
      border-radius: 18px; font-size: 15px; user-select: none;
      z-index: 10;
      display: flex; align-items: center; gap: 6px;
    }
    /* --- Message card --- */
    .message-panel {
      width: 100%;
      max-width: 600px;
      background: var(--card-bg);
      margin: 26px auto 0 auto;
      border-radius: 18px;
      padding: 18px 16px 14px 16px;
      box-shadow: 0 6px 24px #0005;
    }
    .message-panel h3 {
      margin: 0 0 8px 0;
      font-family: 'Audiowide',sans-serif;
      color: var(--accent);
      font-size: 17px;
      letter-spacing: 1px;
    }
    .compose { display: flex; gap: 10px; margin-bottom: 12px; }
    .compose textarea {
      flex: 1; min-height: 56px; resize: vertical;
      padding: 9px 12px; border-radius: 8px; border: none;
      font-size: 15px; background: #232323; color: #fff;
    }
    .compose button {
      min-width: 92px; padding: 10px 12px;
      background: var(--gradient);
      border: none; color: #fff; border-radius: 10px;
      font-weight: 700; cursor: pointer;
    }
    #messagesList { max-height: 240px; overflow:auto; padding-right:6px; }
    .msg-item {
      background: #232323;
      border-radius: 10px; padding: 8px 12px; margin-bottom: 8px;
      color: #fff; word-break: break-word; white-space: pre-wrap;
      font-size: 15px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .msg-wand {
      margin-left: 12px; cursor: pointer; font-size: 18px;
    }
    /* --- Bottom nav --- */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      width: 100vw;
      height: 56px;
      background: var(--card-bg);
      border-top: 1px solid #292929;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 80;
      box-shadow: 0 -2px 14px #0009;
    }
    .bottom-nav button {
      background: none; border: none; color: #fff;
      font-size: 24px; cursor: pointer;
      transition: color .18s;
      opacity: 0.8;
    }
    .bottom-nav button.active { color: var(--accent); opacity: 1; }
    @media (max-width: 640px) {
      .topbar, .story-bar, .message-panel { max-width: 100vw; }
      .story-bar { gap: 10px; }
      .story-ring { width: 54px; height: 54px;}
      .story-avatar img { width: 48px; height: 48px;}
      .story-avatar .add, .story-avatar img { width:48px; height:48px;}
      .story-avatar .label { font-size: 11px;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Insta Thoughts</h1>
    <button class="add-story-btn" onclick="document.getElementById('storyFile').click()">+ Add Story</button>
    <input type="file" id="storyFile" accept="image/*,video/*" style="display:none"/>
  </div>
  <div class="story-bar" id="storyBar">
    <!-- Story Avatars dynamically here -->
  </div>
  <!-- Story Overlay -->
  <div class="story-overlay" id="storyOverlay">
    <div class="story-media" id="storyMedia">
      <button class="close-btn" onclick="closeStoryView()">&#10005;</button>
      <span class="play-count" id="overlayPlayCount">üëÅÔ∏è 0</span>
      <!-- Media here -->
    </div>
  </div>
  <div class="message-panel">
    <h3>Send me an anonymous message</h3>
    <div class="compose">
      <textarea id="newMsg" placeholder="Write your message..."></textarea>
      <button id="sendBtn" type="button">Send</button>
    </div>
    <div id="messagesList"></div>
  </div>
  <nav class="bottom-nav">
    <button class="active" title="Home">&#8962;</button>
    <button title="Search">&#128269;</button>
    <button title="Stories">&#128247;</button>
    <button title="Messages">&#9993;</button>
    <button title="Profile">&#128100;</button>
  </nav>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, runTransaction, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyAkeirE4twM3J02JbDBnbdUw2G9yw8VVlw",
      authDomain: "love-messages-cdee7.firebaseapp.com",
      databaseURL: "https://love-messages-cdee7-default-rtdb.firebaseio.com",
      projectId: "love-messages-cdee7",
      storageBucket: "love-messages-cdee7.appspot.com",
      messagingSenderId: "670131200783",
      appId: "1:670131200783:web:ea75b017acab258911547a",
      measurementId: "G-WT5TKSRSLG"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // === Anonymous Stories ===
    const storyBar = document.getElementById('storyBar');
    const storyFileInput = document.getElementById('storyFile');
    let storiesCache = [];
    let seenStories = JSON.parse(localStorage.getItem('seenStories')||'{}');

    function renderStories(storyArr) {
      storyBar.innerHTML = '';
      // Add "Your Story" always first
      const myStory = document.createElement('div');
      myStory.className = 'story-avatar';
      myStory.innerHTML = `<div class="story-ring"><button class="add" onclick="document.getElementById('storyFile').click()">+</button></div><span class="label">Your Story</span>`;
      storyBar.appendChild(myStory);

      storyArr.forEach(story=>{
        const div = document.createElement('div');
        div.className = 'story-avatar';
        div.innerHTML = `
          <div class="story-ring${seenStories[story.id] ? ' seen':''}" data-storyid="${story.id}">
            <img src="${story.thumb||story.url}" alt="story"/>
          </div>
          <span class="label">${story.name||'User'}</span>
        `;
        div.querySelector('.story-ring').onclick = ()=>openStoryView(story.id);
        storyBar.appendChild(div);
      });
    }

    // Listen to stories
    function listenStories() {
      const storiesRef = ref(db, 'stories');
      onValue(storiesRef, snap=>{
        let arr = [];
        if(snap.exists()){
          arr = Object.entries(snap.val())
            .map(([id, val])=>({...val, id}))
            .filter(story=>Date.now() - story.ts < 86400000); // 24h
          storiesCache = arr.sort((a,b)=>b.ts-a.ts);
          renderStories(storiesCache);
        }
      });
    }
    listenStories();

    // Clean up expired stories
    async function cleanOldStories() {
      const storiesRef = ref(db, 'stories');
      const snap = await get(storiesRef);
      if (snap.exists()) {
        for (let [id, val] of Object.entries(snap.val())) {
          if (Date.now() - val.ts > 86400000) {
            // Delete from DB & Storage
            await remove(ref(db, 'stories/'+id));
            if (val.storagePath) {
              try { await deleteObject(sRef(storage, val.storagePath)); } catch(e){}
            }
          }
        }
      }
    }
    setInterval(cleanOldStories, 60*60*1000); // 1 hr

    // Add story (image/video upload)
    storyFileInput.onchange = async function(e) {
      const file = e.target.files[0];
      if(!file) return;
      let ext = file.type.startsWith('image/') ? 'img' : file.type.startsWith('video/') ? 'vid' : '';
      if(!ext) return alert('Only image/video allowed!');
      let name = prompt("Your name (optional for story ring)?") || "Anonymous";
      const id = Math.random().toString(36).slice(2);
      const storagePath = `stories/${id}-${file.name}`;
      const uploadRef = sRef(storage, storagePath);
      const snapshot = await uploadBytes(uploadRef, file);
      const url = await getDownloadURL(uploadRef);
      let thumb = url;
      if(ext==='vid') thumb="https://img.icons8.com/color/96/000000/video.png";
      // Save to DB
      await set(ref(db, 'stories/'+id), {url, ts: Date.now(), type: ext, name, storagePath, thumb});
      alert('Story uploaded! Will expire in 24h.');
      storyFileInput.value = '';
    };

    // Story overlay logic
    let currentStory = null;
    window.openStoryView = async function(storyId) {
      const story = storiesCache.find(s=>s.id===storyId);
      if(!story) return;
      currentStory = story;
      // Mark as seen
      seenStories[storyId] = Date.now();
      localStorage.setItem('seenStories', JSON.stringify(seenStories));
      // Overlay UI
      document.getElementById('storyOverlay').classList.add('active');
      const media = document.getElementById('storyMedia');
      media.querySelectorAll('img,video').forEach(x=>x.remove());
      let el;
      if(story.type==='img') {
        el = document.createElement('img');
        el.src = story.url;
      } else {
        el = document.createElement('video');
        el.src = story.url;
        el.controls = true;
        el.autoplay = true;
        el.loop = false;
      }
      media.appendChild(el);
      // Play count
      incrementStoryView(storyId);
      listenStoryViews(storyId);

      // Auto close after 12s (like Insta)
      setTimeout(()=>{ if(document.getElementById('storyOverlay').classList.contains('active')) closeStoryView(); }, 12000);
    }
    window.closeStoryView = function() {
      document.getElementById('storyOverlay').classList.remove('active');
      // Remove play count listener?
    }

    // === Story View Count ===
    function incrementStoryView(storyId) {
      const viewsRef = ref(db, 'storyViews/'+storyId);
      runTransaction(viewsRef, val=>(val||0)+1);
    }
    function listenStoryViews(storyId) {
      const viewsRef = ref(db, 'storyViews/'+storyId);
      onValue(viewsRef, snap=>{
        document.getElementById('overlayPlayCount').innerHTML = `üëÅÔ∏è ${snap.exists()?snap.val():0}`;
      });
    }

    // === ANONYMOUS MESSAGES ===
    const messagesRef = ref(db, 'messages');
    const messagesListEl = document.getElementById('messagesList');
    const ADMIN_PASS = "0420";
    function renderSnapshot(snapshotVal) {
      messagesListEl.innerHTML = "";
      if(!snapshotVal) return;
      const arr = Object.keys(snapshotVal).map(id=>{
        const it = snapshotVal[id];
        return { id, text: it.text||'', ts: it.ts||0 };
      }).sort((a,b)=>b.ts-a.ts);
      arr.forEach(item=>{
        const d=document.createElement('div');
        d.className='msg-item';
        d.innerHTML = `<span>${item.text}</span>
          <span class="msg-wand" title="Remove (admin)">üóëÔ∏è</span>`;
        d.querySelector('.msg-wand').onclick = async ()=>{
          const pass=prompt('Admin password?');
          if(pass===ADMIN_PASS){
            try{ await remove(ref(db,'messages/'+item.id)); }catch(err){ alert('Delete failed'); }
          } else if(pass!==null){ alert('‚ùå Wrong password!'); }
        };
        messagesListEl.appendChild(d);
      });
    }
    onValue(messagesRef, snap=>renderSnapshot(snap.exists()?snap.val():null));

    const sendBtn=document.getElementById('sendBtn');
    const newMsgEl=document.getElementById('newMsg');
    sendBtn.onclick = async ()=>{
      const text=(newMsgEl.value||"").trim();
      if(!text){ alert('Type something!'); return; }
      try{ await push(messagesRef,{ text, ts:Date.now() }); newMsgEl.value=""; }
      catch(err){ alert('Send failed'); }
    };
    newMsgEl.addEventListener('keydown', e=>{
      if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)) sendBtn.click();
    });
  </script>
</body>
  </html>
