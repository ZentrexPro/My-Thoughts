<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta Thoughts</title>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Audiowide&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ... keep all your CSS here, unchanged ... */
    .login-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.94);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .login-modal .modal-box {
      background: #232323;
      padding: 36px 26px 26px 26px;
      border-radius: 18px;
      box-shadow: 0 8px 32px #000b;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 260px;
    }
    .login-modal h2 {
      margin: 0 0 22px 0;
      color: var(--accent);
      font-family: 'Audiowide', cursive;
      font-size: 1.5em;
    }
    .login-modal button {
      margin: 8px 0;
      width: 160px;
      padding: 10px 0;
      font-size: 1.08em;
      border-radius: 10px;
      border: none;
      background: var(--gradient);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: box-shadow .2s;
      box-shadow: 0 2px 8px #0003;
    }
    .login-modal input[type="password"] {
      margin: 12px 0 0 0;
      border-radius: 7px;
      border: none;
      padding: 9px 10px;
      font-size: 1em;
      background: #181818;
      color: #eee;
      width: 140px;
      text-align: center;
    }
    .login-modal .error {
      color: #fd1d1d;
      font-size: 0.95em;
      margin-top: 8px;
      min-height: 22px;
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div class="login-modal" id="loginModal">
    <div class="modal-box" id="modalBox">
      <h2>Login as</h2>
      <button id="userLoginBtn">Continue as User</button>
      <button id="adminLoginBtn">Login as Admin</button>
      <div id="adminPassBox" style="display:none;">
        <input type="password" id="adminPassInput" placeholder="Enter Admin Password"/>
        <button id="adminPassSubmit">Submit</button>
        <div class="error" id="adminPassError"></div>
      </div>
    </div>
  </div>

  <div class="topbar">
    <h1>Insta Thoughts</h1>
    <button class="add-story-btn" id="addStoryBtn" style="display:none;">+ Add Story</button>
    <input type="file" id="storyFile" accept="image/*,video/*" style="display:none"/>
  </div>
  <div class="story-bar" id="storyBar">
    <!-- Story Avatars dynamically here -->
  </div>
  <!-- Story Overlay -->
  <div class="story-overlay" id="storyOverlay">
    <div class="story-media" id="storyMedia">
      <button class="close-btn" onclick="window.closeStoryView()">&#10005;</button>
      <span class="play-count" id="overlayPlayCount">üëÅÔ∏è 0</span>
      <!-- Media here -->
    </div>
  </div>
  <div class="message-panel">
    <h3>Send me an anonymous message</h3>
    <div class="compose">
      <textarea id="newMsg" placeholder="Write your message..."></textarea>
      <button id="sendBtn" type="button">Send</button>
    </div>
    <div id="messagesList"></div>
  </div>
  <nav class="bottom-nav">
    <button class="active" title="Home">&#8962;</button>
    <button title="Search">&#128269;</button>
    <button title="Stories">&#128247;</button>
    <button title="Messages">&#9993;</button>
    <button title="Profile">&#128100;</button>
  </nav>
  <script type="module">
    // LOGIN MODAL LOGIC
    let isAdmin = false;
    let isLoggedIn = false;

    const loginModal = document.getElementById('loginModal');
    const userLoginBtn = document.getElementById('userLoginBtn');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminPassBox = document.getElementById('adminPassBox');
    const adminPassInput = document.getElementById('adminPassInput');
    const adminPassSubmit = document.getElementById('adminPassSubmit');
    const adminPassError = document.getElementById('adminPassError');
    const addStoryBtn = document.getElementById('addStoryBtn');
    const storyFileInput = document.getElementById('storyFile');

    userLoginBtn.onclick = ()=>{
      isAdmin = false;
      isLoggedIn = true;
      loginModal.style.display = 'none';
      updateUIForRole();
    };
    adminLoginBtn.onclick = ()=>{
      adminPassBox.style.display = 'block';
      adminPassInput.focus();
    };
    adminPassSubmit.onclick = ()=>{
      if(adminPassInput.value === "0420"){
        isAdmin = true;
        isLoggedIn = true;
        loginModal.style.display = 'none';
        adminPassError.textContent = '';
        updateUIForRole();
      } else {
        adminPassError.textContent = "Wrong password!";
        adminPassInput.value = "";
        adminPassInput.focus();
      }
    };
    adminPassInput.addEventListener('keydown', e=>{
      if(e.key==="Enter") adminPassSubmit.click();
    });

    function updateUIForRole(){
      // Only admin can see Add Story button
      addStoryBtn.style.display = isAdmin ? 'inline-block' : 'none';
      // Only admin can click upload
      if(!isAdmin){
        storyFileInput.value = "";
        storyFileInput.disabled = true;
      } else {
        storyFileInput.disabled = false;
      }
    }

    // --- Page JS, run only after login ---
    function afterLoginInit(){
      // --- All your Firebase code here ---
      import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js").then(({initializeApp})=>{
      import("https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js").then(dbmod=>{
      import("https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js").then(storagemod=>{
      const { getDatabase, ref, push, onValue, remove, runTransaction, set, get } = dbmod;
      const { getStorage, ref: sRef, uploadBytes, getDownloadURL, deleteObject } = storagemod;

      const firebaseConfig = {
        apiKey: "AIzaSyAkeirE4twM3J02JbDBnbdUw2G9yw8VVlw",
        authDomain: "love-messages-cdee7.firebaseapp.com",
        databaseURL: "https://love-messages-cdee7-default-rtdb.firebaseio.com",
        projectId: "love-messages-cdee7",
        storageBucket: "love-messages-cdee7.appspot.com",
        messagingSenderId: "670131200783",
        appId: "1:670131200783:web:ea75b017acab258911547a",
        measurementId: "G-WT5TKSRSLG"
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const storage = getStorage(app);

      // === Anonymous Stories ===
      const storyBar = document.getElementById('storyBar');
      let storiesCache = [];
      let seenStories = JSON.parse(localStorage.getItem('seenStories')||'{}');

      function renderStories(storyArr) {
        storyBar.innerHTML = '';
        // Add "Your Story" always first for admin only
        if(isAdmin){
          const myStory = document.createElement('div');
          myStory.className = 'story-avatar';
          myStory.innerHTML = `<div class="story-ring"><button class="add" id="addStoryCircle">+</button></div><span class="label">Your Story</span>`;
          storyBar.appendChild(myStory);
          setTimeout(()=>{ 
            const btn = document.getElementById('addStoryCircle');
            if(btn) btn.onclick = ()=>storyFileInput.click();
          }, 100);
        }
        storyArr.forEach(story=>{
          const div = document.createElement('div');
          div.className = 'story-avatar';
          div.innerHTML = `
            <div class="story-ring${seenStories[story.id] ? ' seen':''}" data-storyid="${story.id}">
              <img src="${story.thumb||story.url}" alt="story"/>
            </div>
            <span class="label">${story.name||'User'}</span>
          `;
          div.querySelector('.story-ring').onclick = ()=>window.openStoryView(story.id);
          storyBar.appendChild(div);
        });
      }

      // Listen to stories
      function listenStories() {
        const storiesRef = ref(db, 'stories');
        onValue(storiesRef, snap=>{
          let arr = [];
          if(snap.exists()){
            arr = Object.entries(snap.val())
              .map(([id, val])=>({...val, id}))
              .filter(story=>Date.now() - story.ts < 86400000); // 24h
            storiesCache = arr.sort((a,b)=>b.ts-a.ts);
            renderStories(storiesCache);
          }
        });
      }
      listenStories();

      // Clean up expired stories
      async function cleanOldStories() {
        const storiesRef = ref(db, 'stories');
        const snap = await get(storiesRef);
        if (snap.exists()) {
          for (let [id, val] of Object.entries(snap.val())) {
            if (Date.now() - val.ts > 86400000) {
              // Delete from DB & Storage
              await remove(ref(db, 'stories/'+id));
              if (val.storagePath) {
                try { await deleteObject(sRef(storage, val.storagePath)); } catch(e){}
              }
            }
          }
        }
      }
      setInterval(cleanOldStories, 60*60*1000); // 1 hr

      // Add story (image/video upload) - only admin
      storyFileInput.onchange = async function(e) {
        if(!isAdmin) return;
        const file = e.target.files[0];
        if(!file) return;
        let ext = file.type.startsWith('image/') ? 'img' : file.type.startsWith('video/') ? 'vid' : '';
        if(!ext) return alert('Only image/video allowed!');
        let name = prompt("Your name (optional for story ring)?") || "Anonymous";
        const id = Math.random().toString(36).slice(2);
        const storagePath = `stories/${id}-${file.name}`;
        const uploadRef = sRef(storage, storagePath);
        const snapshot = await uploadBytes(uploadRef, file);
        const url = await getDownloadURL(uploadRef);
        let thumb = url;
        if(ext==='vid') thumb="https://img.icons8.com/color/96/000000/video.png";
        // Save to DB
        await set(ref(db, 'stories/'+id), {url, ts: Date.now(), type: ext, name, storagePath, thumb});
        alert('Story uploaded! Will expire in 24h.');
        storyFileInput.value = '';
      };

      // Story overlay logic
      let currentStory = null;
      window.openStoryView = async function(storyId) {
        const story = storiesCache.find(s=>s.id===storyId);
        if(!story) return;
        currentStory = story;
        // Mark as seen
        seenStories[storyId] = Date.now();
        localStorage.setItem('seenStories', JSON.stringify(seenStories));
        // Overlay UI
        document.getElementById('storyOverlay').classList.add('active');
        const media = document.getElementById('storyMedia');
        media.querySelectorAll('img,video').forEach(x=>x.remove());
        let el;
        if(story.type==='img') {
          el = document.createElement('img');
          el.src = story.url;
        } else {
          el = document.createElement('video');
          el.src = story.url;
          el.controls = true;
          el.autoplay = true;
          el.loop = false;
        }
        media.appendChild(el);
        // Play count
        incrementStoryView(storyId);
        listenStoryViews(storyId);

        // Auto close after 12s (like Insta)
        setTimeout(()=>{ if(document.getElementById('storyOverlay').classList.contains('active')) window.closeStoryView(); }, 12000);
      }
      window.closeStoryView = function() {
        document.getElementById('storyOverlay').classList.remove('active');
      }

      // === Story View Count ===
      function incrementStoryView(storyId) {
        const viewsRef = ref(db, 'storyViews/'+storyId);
        runTransaction(viewsRef, val=>(val||0)+1);
      }
      function listenStoryViews(storyId) {
        const viewsRef = ref(db, 'storyViews/'+storyId);
        onValue(viewsRef, snap=>{
          document.getElementById('overlayPlayCount').innerHTML = `üëÅÔ∏è ${snap.exists()?snap.val():0}`;
        });
      }

      // === ANONYMOUS MESSAGES ===
      const messagesRef = ref(db, 'messages');
      const messagesListEl = document.getElementById('messagesList');
      function renderSnapshot(snapshotVal) {
        messagesListEl.innerHTML = "";
        if(!snapshotVal) return;
        const arr = Object.keys(snapshotVal).map(id=>{
          const it = snapshotVal[id];
          return { id, text: it.text||'', ts: it.ts||0 };
        }).sort((a,b)=>b.ts-a.ts);
        arr.forEach(item=>{
          const d=document.createElement('div');
          d.className='msg-item';
          d.innerHTML = `<span>${item.text}</span>
            <span class="msg-wand" title="Remove (admin)">üóëÔ∏è</span>`;
          d.querySelector('.msg-wand').onclick = async ()=>{
            if(!isAdmin){
              alert("Only admin can delete!");
              return;
            }
            const pass=prompt('Admin password?');
            if(pass==="0420"){
              try{ await remove(ref(db,'messages/'+item.id)); }catch(err){ alert('Delete failed'); }
            } else if(pass!==null){ alert('‚ùå Wrong password!'); }
          };
          messagesListEl.appendChild(d);
        });
      }
      onValue(messagesRef, snap=>renderSnapshot(snap.exists()?snap.val():null));

      const sendBtn=document.getElementById('sendBtn');
      const newMsgEl=document.getElementById('newMsg');
      sendBtn.onclick = async ()=>{
        const text=(newMsgEl.value||"").trim();
        if(!text){ alert('Type something!'); return; }
        try{ await push(messagesRef,{ text, ts:Date.now() }); newMsgEl.value=""; }
        catch(err){ alert('Send failed'); }
      };
      newMsgEl.addEventListener('keydown', e=>{
        if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)) sendBtn.click();
      });

      // -- End of Firebase logic --
      });});});
    }

    // Wait for login before initializing everything else
    function checkLoginAndInit(){
      if(isLoggedIn){
        afterLoginInit();
      } else {
        setTimeout(checkLoginAndInit, 200);
      }
    }
    checkLoginAndInit();
  </script>
</body>
</html>
